
<script type="text/javascript" src="{{ site.baseurl }}/assets/js/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="{{ site.baseurl }}/assets/js/date.js"></script>
<section id="comment">
    <h2>读者评论</h2>
    <!-- JavaScript objects are not JSON :-) -->
    <script type="text/javascript">
        // Global Variables
        var html; // STRING, get changed by side effects of functions
        var json; // OBJECT, get changed by side effects
        var jsComment; // LIST of OBJECT
        var iIssue = 0; // INTEGER
        var milestoneID = {{ page.milestoneID }};
        var apiIssues = "https://api.github.com/repos/mountaye/blog/issues";
        var dateOption =  { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' };
        var reaction_fa = { "+1": "thumbs-o-up",
                            "-1": "thumbs-o-down",
                            "laugh": "smile-o",
                            "hooray": "gift",
                            "confused": "frown-o",
                            "heart": "heart-o"};
        // Functions 
        function getReactionsStr(json){
            var reactions="";
            for (iReact in reaction_fa){
                if (json[iReact] > 0){
                    reactions += '<i class="fa fa-'+ reaction_fa[reactionkey]+'"></i>' + reactions[reactionkey] + "&nbsp;";
                };
            };
            return reactions
        };
        function printJson(){
            html = "<div class='ghReaderZone'><hr class='slender'>";
            for (var i = 0; i < json.length; i++){
                var issueDate = new Date(json[i].created_at).toLocaleString("zh-Hans", dateOption);
                var issueBody = json[i].body_html || json[i].body;
                var issueReact = "";
                if (json[i].reactions){issueReact = getReactionsStr(json[i].reactions);};
                // Other variables easy to get from the json are hard-coded inside the string manipulation.
                html += "<div class='ghIssue'><div class='ghIssueLogo'><a href='" + json[i].user.url + "'><img src='" + json[i].user.avatar_url + "' width='48' class='ghIssueObject'></a></div><div class='ghIssueBox'><h4 class='ghIssueHeading'><a class='ghIssueUser' href="+json[i].user.url+"> "+ json[i].user.login +" </a><small><a class='ghIssueDate' href=" + json[i].html_url + ">" + issueDate + "</a></small>&nbsp;"+ issueReact + "<span class='ghIssueTitle'>" + json[i].title + "</span></h4><div class='ghIssueBody markdown-body'>" + issueBody + "</div></div></div>";
                // if ( json[i].hasOwnProperty('commentsMountaye') ){alert("yes")}else{alert("no")};
                if ( json[i].hasOwnProperty("commentsMountaye") ){
                    for (var j = 0; j < json[i].commentsMountaye.length; j++){
                        var commentDate = new Date(json[i].commentsMountaye[j].created_at).toLocaleString("zh-Hans", dateOption);
                        var commentBody = json[i].commentsMountaye[j].body_html || json[i].commentsMountaye[j].body; // json[i].commentsMountaye[j].body
                        var commentReact = ""; 
                        if (json[i].commentsMountaye[j].reactions){commentReact = getReactionsStr(json[i].commentsMountaye[j].reactions);};
                        html += "<div class='ghComment'><div class='ghCommentLogo'><a href='" + json[i].commentsMountaye[j].user.url + "'><img src='" + json[i].commentsMountaye[j].user.avatar_url + "' width='48' class='ghIssueObject'></a></div><div class='ghCommentBox'><h4 class='ghCommentHeading'><a class='ghCommentUser' href='" + json[i].commentsMountaye[j].user.url + "'>" + json[i].commentsMountaye[j].user.login + "</a><small>&nbsp; 留言於 &nbsp;<a class='ghCommentDate' href=' json[i].commentsMountaye[j].user.url '>" + commentDate + "</a></small>&nbsp;"+ commentReact + "</h4><div class='commentGithubFloorsBody markdown-body'>" + commentBody + "</div></div></div>";
                    };
                };
            };
            html += "</div>";
            $("#commentContent").append(html);
            $(".email-hidden-toggle > a").on("click", function (e){ e.preventDefault();
                                                                    $(".email-hidden-reply", this.parent).toggle(); } );
        };
        function fetchCommentsFromOneIssue(msg){
            if (json[iIssue].comments > 0){
                $.ajax({ 
                    url: json[iIssue].comments_url,
                    type:"GET",
                    headers:  {Accept:"application/vnd.github.squirrel-girl-preview.full+json"},
                    dataType: "json",
                    success: function(msg){ 
                        json[iIssue].commentsMountaye = msg;
                        iIssue += 1; // side effect
                        $("#comment").trigger("oneCommentLoaded"); 
                    } 
                });    
            }
            else{
                iIssue += 1; // side effect
                $("#comment").trigger("oneCommentLoaded");
            }
        };
        function fetchCommentsIf(){
            if (iIssue==json.length){
                iIssue = 0;
                $("#comment").trigger("jsonReady");
            }
            else {$("#comment").trigger("fetchCommentsFromOneIssue");};
        };
        function issuesFetched(msg){
            json = msg;
            if (json==undefined){
                html = "<p>目前尚无评论。</p>";
                $("#comment").trigger("jsonReady");
            }
            else { $("#comment").trigger("hasIssues"); };
        };
        function errorIssues(){ html = "<p>网络异常，留言装填失败。</p>"; $("#comment").trigger("printComments"); };
        function loadIssues(){
            $.ajax({ 
                url: apiIssues,
                type: "GET",
                data: {milestone: milestoneID},
                headers: {Accept:"application/vnd.github.squirrel-girl-preview.full+json"},
                dataType: "json",
                success: function(msg){issuesFetched(msg);}, 
                error: errorIssues 
            });
        };
        // Async dependence
        $("#comment").on("fetchCommentsFromOneIssue",fetchCommentsFromOneIssue);
        $("#comment").on("oneCommentLoaded",fetchCommentsIf);
        $("#comment").on("hasIssues",fetchCommentsFromOneIssue);
        $("#comment").on("jsonReady",printJson);
        // Real Working Code :-) 
        document.addEventListener("DOMContentLoaded", loadIssues);
    </script>
    <noscript><p>查看留言，请启用 JavaScript。</p></noscript>
    
    <div id="commentIntro">
        <p>GitHub 用户可前往<a href="https://github.com/MountAye/blog/milestone/{{page.milestoneID}}">本文对应的 Milestone 页面</a>进行评论。</p>
    </div>
    <div id="commentContent"></div>
</section>
<div id="test"></div>
