
<script type="text/javascript" src="{{ site.baseurl }}/assets/js/jquery-3.4.1.min.js"></script>
<script type="text/javascript" src="{{ site.baseurl }}/assets/js/date.js"></script>
<section id="comment">
    <h2>读者评论</h2>
    <!-- JavaScript objects are not JSON :-) -->
    <script type="text/javascript">
        // Global Variables
        var milestoneID = {{ page.milestoneID }};
        var html = "<div class='ghReaderZone'><hr class='slender'>"; // STRING, get changed by side effects of functions
        var json; // OBJECT, get changed by side effects
        var iIssue = 0; // INTEGER
        var apiIssues = "https://api.github.com/repos/mountaye/blog/issues";
        var dateOption =  { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit' };
        var reaction_fa = { "+1": "thumbs-o-up",
                            "-1": "thumbs-o-down",
                            "laugh": "smile-o",
                            "hooray": "gift",
                            "confused": "frown-o",
                            "heart": "heart-o"};
        // Functions 
        function getReactionsStr(json){
            var reactions="";
            for (iReact in reaction_fa){
                if (json[iReact] > 0){
                    reactions += '<i class="fa fa-'+ reaction_fa[reactionkey]+'"></i>' + reactions[reactionkey] + "&nbsp;";
                };
            };
            return reactions
        };
        function printJson(){
            for (var i = json.length - 1; i >= 0 ; i--){
                var issueTitle = json[i].title;
                var issueUser = json[i].user.login;
                var issueUserUrl = json[i].user.html_url;
                var issueLogoUrl = json[i].user.avatar_url;
                var issueDate = new Date(json[i].created_at).toLocaleString("zh-Hans", dateOption);
                var issueBody = json[i].body_html || json[i].body;
                var issueReact = "";
                if (json[i].reactions){issueReact = getReactionsStr(json[i].reactions);};
                html += '<div class="ghIssue"><h3 class="ghIssueTitle">' + issueTitle + '</h3><div class="ghBoth"><div class="ghLogo"><a href="' + issueUserUrl + '"><img src="' + issueLogoUrl + '" width="48"></a></div><div class="ghText"><div class="ghIssueAuthorInfo"><a class="ghIssueAuthor" href="' + issueUserUrl + '">' + issueUser + '</a><small class="ghIssueDate">' + issueDate + '</small></div><blockquote class="ghBody markdown-body">' + issueBody + '</blockquote>' + issueReact + '<hr class="slender"></div></div>';
                if ( json[i].hasOwnProperty("commentsMountaye") ){
                    for (var j = json[i].commentsMountaye.length - 1; j >= 0 ; j--){
                        var commentUser = json[i].commentsMountaye[j].user.login;
                        var commentUserUrl = json[i].commentsMountaye[j].user.html_url;
                        var commentLogoUrl = json[i].commentsMountaye[j].user.avatar_url;
                        var commentDate = new Date(json[i].commentsMountaye[j].created_at).toLocaleString("zh-Hans", dateOption);
                        var commentBody = json[i].commentsMountaye[j].body_html || json[i].commentsMountaye[j].body; // json[i].commentsMountaye[j].body
                        var commentReact = ""; 
                        if (json[i].commentsMountaye[j].reactions){commentReact = getReactionsStr(json[i].commentsMountaye[j].reactions);};
                        html += '<div class="ghComment"><div class="ghBoth"><div class="ghLogo"><a href="' + commentUserUrl + '"><img src="' + commentLogoUrl + '" width="48"></a></div><div class="ghText"><div class="ghCommentAuthorInfo"><a class="ghCommentAuthor" href="' + commentUserUrl + '">' + commentUser + '</a><small class="ghCommentDate">' + commentDate + '</small></div><blockquote class="ghBody markdown-body">' + commentBody + '</blockquote>' + commentReact + '</div></div>';
                        if (j!=0){
                            html += '<hr class="slender"></div>';
                        };
                    };
                };
                html += '<hr class="slender"></div>';
            };
            html += "</div>";
            $("#commentContent").append(html);
            $(".email-hidden-toggle > a").on("click", function (e){ e.preventDefault();
                                                                    $(".email-hidden-reply", this.parent).toggle(); } );
        };
        function fetchCommentsFromOneIssue(msg){
            if (json[iIssue].comments > 0){
                $.ajax({ 
                    url: json[iIssue].comments_url,
                    type:"GET",
                    headers:  {Accept:"application/vnd.github.squirrel-girl-preview.full+json"},
                    dataType: "json",
                    success: function(msg){ 
                        json[iIssue].commentsMountaye = msg;
                        iIssue += 1; // side effect
                        $("#comment").trigger("oneCommentLoaded"); 
                    } 
                });    
            }
            else{
                iIssue += 1; // side effect
                $("#comment").trigger("oneCommentLoaded");
            }
        };
        function fetchCommentsIf(){
            if (iIssue==json.length){
                iIssue = 0;
                $("#comment").trigger("jsonReady");
            }
            else {$("#comment").trigger("fetchCommentsFromOneIssue");};
        };
        function issuesFetched(msg){
            json = msg;
            if ( json.length == 0 ){
                html += "<p>本文目前尚无评论。</p>";
                $("#comment").trigger("jsonReady");
            }
            else { $("#comment").trigger("hasIssues"); };
        };
        function errorIssues(){ html += "<p>网络异常，留言装填失败。</p>"; $("#comment").trigger("jsonReady"); };
        function loadIssues(){
            $.ajax({ 
                url: apiIssues,
                type: "GET",
                data: {milestone: milestoneID},
                headers: {Accept:"application/vnd.github.squirrel-girl-preview.full+json"},
                dataType: "json",
                success: function(msg){issuesFetched(msg);}, 
                error: errorIssues 
            });
        };
        // Async dependence
        $("#comment").on("fetchCommentsFromOneIssue",fetchCommentsFromOneIssue);
        $("#comment").on("oneCommentLoaded",fetchCommentsIf);
        $("#comment").on("hasIssues",fetchCommentsFromOneIssue);
        $("#comment").on("jsonReady",printJson);
        // Real Working Code :-) 
        document.addEventListener("DOMContentLoaded", loadIssues);
    </script>
    <noscript><p>查看留言，请启用 JavaScript。</p></noscript>
    
    <div id="commentIntro">
        <p>GitHub 用户可前往<a href="https://github.com/MountAye/blog/milestone/{{page.milestoneID}}">本文对应的 Milestone 页面</a>进行评论。</p>
    </div>
    <div id="commentContent"></div>
</section>
